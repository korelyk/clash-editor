<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Clash Verge èŠ‚ç‚¹é…ç½®ç¼–è¾‘å™¨</title>
  <script src="https://cdn.jsdelivr.net/npm/js-yaml@4.1.0/dist/js-yaml.min.js"></script>
  <script src="https://unpkg.com/@phosphor-icons/web"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap');

    :root {
      /* Modern Dark Palette - Enhanced */
      --bg-color: #0f172a;
      --surface-glass: rgba(30, 41, 59, 0.7);
      --surface-glass-hover: rgba(51, 65, 85, 0.8);
      --border-glass: rgba(255, 255, 255, 0.1);
      --text-primary: #f8fafc;
      --text-secondary: #94a3b8;

      /* Vibrant Accents */
      --primary-gradient: linear-gradient(135deg, #6366f1 0%, #a855f7 100%);
      --primary-glow: 0 0 25px rgba(168, 85, 247, 0.5);
      --accent: #8b5cf6;

      /* Node Colors (Neon) */
      --ss: #3b82f6;
      /* Blue */
      --vmess: #d946ef;
      /* Fuchsia */
      --trojan: #f59e0b;
      /* Amber */
      --hysteria2: #10b981;
      /* Emerald */
      --vless: #06b6d4;
      /* Cyan */
      --hy2: #10b981;

      /* Functional Colors */
      --danger: #ef4444;
      --success: #22c55e;
      --warn: #f59e0b;

      --radius: 20px;
      --radius-sm: 12px;
      --shadow-lg: 0 20px 40px -10px rgba(0, 0, 0, 0.6);
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background-color: var(--bg-color);
      color: var(--text-primary);
      line-height: 1.6;
      min-height: 100vh;
      overflow-x: hidden;
      position: relative;
    }

    /* Animated Background Blobs */
    body::before,
    body::after {
      content: '';
      position: fixed;
      width: 600px;
      height: 600px;
      border-radius: 50%;
      filter: blur(80px);
      z-index: -1;
      opacity: 0.4;
      animation: float 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
    }

    body::before {
      background: radial-gradient(#4f46e5, transparent 70%);
      top: -100px;
      left: -100px;
    }

    body::after {
      background: radial-gradient(#ec4899, transparent 70%);
      bottom: -100px;
      right: -100px;
      animation-delay: -10s;
    }

    @keyframes float {
      0% {
        transform: translate(0, 0) scale(1);
      }

      100% {
        transform: translate(100px, 50px) scale(1.1);
      }
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 6px;
      height: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 10px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    button {
      cursor: pointer;
      border: none;
      font-family: inherit;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Inputs & Forms */
    input,
    select,
    textarea {
      font-family: inherit;
      color: var(--text-primary);
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-sm);
      padding: 12px 16px;
      width: 100%;
      transition: all 0.3s ease;
      backdrop-filter: blur(4px);
    }

    input:focus,
    select:focus,
    textarea:focus {
      outline: none;
      border-color: var(--accent);
      background: rgba(30, 41, 59, 0.8);
      box-shadow: 0 0 0 2px rgba(139, 92, 246, 0.3);
      transform: translateY(-1px);
    }

    select {
      appearance: none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%2394a3b8' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
      background-repeat: no-repeat;
      background-position: right 14px center;
      padding-right: 40px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 40px 24px;
    }

    /* Visual Header */
    .header {
      padding: 40px 0 20px;
      text-align: center;
      position: relative;
      margin-bottom: 40px;
      border-bottom: none;
      background: none;
    }

    .header h1 {
      font-size: 3em;
      font-weight: 800;
      background: linear-gradient(135deg, #fff 0%, #cbd5e1 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      letter-spacing: -2px;
      margin-bottom: 12px;
      text-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
    }

    .header p {
      color: var(--text-secondary);
      font-size: 1.1em;
      font-weight: 300;
      letter-spacing: 0.5px;
    }

    /* Glass Sections */
    .section {
      background: var(--surface-glass);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius);
      padding: 32px;
      margin-bottom: 32px;
      backdrop-filter: blur(20px);
      box-shadow: var(--shadow-lg);
      animation: fadeInUp 0.6s cubic-bezier(0.2, 0.8, 0.2, 1) backwards;
    }

    .section:nth-child(1) {
      animation-delay: 0.1s;
    }

    .section:nth-child(2) {
      animation-delay: 0.2s;
    }

    .section:nth-child(3) {
      animation-delay: 0.3s;
    }

    .section-title {
      font-size: 1.4em;
      font-weight: 700;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 12px;
      color: var(--text-primary);
      padding-bottom: 16px;
      border-bottom: 1px solid var(--border-glass);
    }

    .section-title i {
      font-size: 1.25em;
      color: var(--accent);
    }

    /* Modern Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      padding: 12px 24px;
      border-radius: 100px;
      /* Pill shape */
      font-size: 1em;
      font-weight: 600;
      letter-spacing: 0.3px;
      position: relative;
      overflow: hidden;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
    }

    .btn-primary {
      background: var(--primary-gradient);
      color: #fff;
      box-shadow: var(--primary-glow);
      border: 1px solid rgba(255, 255, 255, 0.1);
    }

    .btn-primary:hover {
      transform: translateY(-3px) scale(1.02);
      box-shadow: 0 10px 30px rgba(168, 85, 247, 0.5);
    }

    .btn-primary:active {
      transform: translateY(-1px);
    }

    .btn-danger {
      background: rgba(239, 68, 68, 0.1);
      color: #ef4444;
      border: 1px solid rgba(239, 68, 68, 0.2);
    }

    .btn-danger:hover {
      background: rgba(239, 68, 68, 0.2);
      border-color: #ef4444;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.2);
    }

    .btn-success {
      background: rgba(34, 197, 94, 0.1);
      color: #22c55e;
      border: 1px solid rgba(34, 197, 94, 0.2);
    }

    .btn-success:hover {
      background: rgba(34, 197, 94, 0.2);
      border-color: #22c55e;
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(34, 197, 94, 0.2);
    }

    .btn-outline {
      background: transparent;
      color: var(--text-secondary);
      border: 1px solid var(--border-glass);
    }

    .btn-outline:hover {
      border-color: var(--text-primary);
      color: var(--text-primary);
      background: rgba(255, 255, 255, 0.05);
      transform: translateY(-2px);
    }

    .btn-small {
      padding: 8px 16px;
      font-size: 0.9em;
    }

    .btn-group {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    /* Upload/Import Area */
    .file-label {
      display: inline-flex;
      align-items: center;
      gap: 10px;
      padding: 12px 24px;
      border-radius: 100px;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-glass);
      cursor: pointer;
      font-size: 1em;
      font-weight: 500;
      transition: all 0.3s;
      color: var(--text-secondary);
    }

    .file-label:hover {
      border-color: var(--accent);
      color: var(--accent);
      background: rgba(139, 92, 246, 0.1);
      transform: translateY(-2px);
    }

    .file-label input[type=file] {
      display: none;
    }

    .import-area textarea {
      height: 160px;
      font-size: 0.9em;
      border-radius: var(--radius-sm);
    }

    /* Link Paste Area */
    .link-area {
      border: 2px dashed rgba(139, 92, 246, 0.3);
      border-radius: var(--radius);
      padding: 32px;
      background: radial-gradient(circle at center, rgba(139, 92, 246, 0.05) 0%, transparent 60%);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-align: center;
    }

    .link-area:hover {
      border-color: var(--accent);
      background: radial-gradient(circle at center, rgba(139, 92, 246, 0.1) 0%, transparent 60%);
    }

    .link-area textarea {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border-glass);
      font-family: 'Consolas', monospace;
      min-height: 100px;
    }

    /* Node Card Results */
    .link-card {
      background: rgba(15, 23, 42, 0.6);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-sm);
      padding: 20px;
      margin-bottom: 16px;
      animation: slideInLeft 0.4s ease-out backwards;
    }

    .link-card.error {
      border-color: rgba(239, 68, 68, 0.5);
      background: rgba(239, 68, 68, 0.05);
    }

    .badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 14px;
      border-radius: 100px;
      font-size: 0.75em;
      font-weight: 800;
      text-transform: uppercase;
      color: #fff;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
      letter-spacing: 0.8px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
    }

    .badge-ss {
      background: var(--ss);
      box-shadow: 0 0 15px rgba(59, 130, 246, 0.4);
    }

    .badge-vmess {
      background: var(--vmess);
      box-shadow: 0 0 15px rgba(217, 70, 239, 0.4);
    }

    .badge-trojan {
      background: var(--trojan);
      box-shadow: 0 0 15px rgba(245, 158, 11, 0.4);
    }

    .badge-hysteria2 {
      background: var(--hysteria2);
      box-shadow: 0 0 15px rgba(16, 185, 129, 0.4);
    }

    .badge-vless {
      background: var(--vless);
      box-shadow: 0 0 15px rgba(6, 182, 212, 0.4);
    }

    .badge-error {
      background: var(--danger);
    }

    /* Proxy Grid */
    .proxy-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .proxy-card {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius);
      padding: 20px;
      position: relative;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      /* Bouncy */
      overflow: hidden;
    }

    .proxy-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 6px;
      height: 100%;
      background: var(--text-secondary);
      transition: all 0.3s;
    }

    .proxy-card:hover {
      transform: translateY(-8px) scale(1.02);
      background: rgba(255, 255, 255, 0.05);
      box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
      border-color: rgba(255, 255, 255, 0.2);
      z-index: 1;
    }

    .proxy-card[data-type=ss]::before {
      background: var(--ss);
    }

    .proxy-card[data-type=vmess]::before {
      background: var(--vmess);
    }

    .proxy-card[data-type=trojan]::before {
      background: var(--trojan);
    }

    .proxy-card[data-type=hysteria2]::before {
      background: var(--hysteria2);
    }

    .proxy-card[data-type=vless]::before {
      background: var(--vless);
    }

    .proxy-card-name {
      font-weight: 700;
      font-size: 1.1em;
      margin-bottom: 8px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .proxy-card-detail {
      font-size: 0.9em;
      color: var(--text-secondary);
      margin-bottom: 6px;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .proxy-card-actions {
      margin-top: 16px;
      display: flex;
      gap: 8px;
      opacity: 0;
      transform: translateY(20px);
      transition: all 0.4s cubic-bezier(0.2, 0.8, 0.2, 1);
    }

    .proxy-card:hover .proxy-card-actions {
      opacity: 1;
      transform: translateY(0);
    }

    /* Layout & Responsive */
    .main-layout {
      display: grid;
      grid-template-columns: 1fr 420px;
      gap: 32px;
    }

    @media(max-width: 1000px) {
      .main-layout {
        grid-template-columns: 1fr;
      }
    }

    .form-section {
      background: rgba(15, 23, 42, 0.7);
      position: sticky;
      top: 32px;
      border: 1px solid var(--accent);
      box-shadow: 0 0 30px rgba(139, 92, 246, 0.15);
      border-radius: var(--radius);
      padding: 24px;
    }

    /* Group Management */
    .group-item {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius-sm);
      margin-bottom: 16px;
      overflow: hidden;
      transition: all 0.2s;
    }

    .group-header {
      padding: 18px 24px;
      display: flex;
      align-items: center;
      gap: 16px;
      cursor: pointer;
      transition: background 0.2s;
    }

    .group-header:hover {
      background: rgba(255, 255, 255, 0.03);
    }

    .group-name {
      font-weight: 700;
      color: #fff;
      flex: 1;
      font-size: 1.05em;
    }

    .group-type-badge {
      font-size: 0.75em;
      padding: 4px 10px;
      border-radius: 6px;
      background: rgba(255, 255, 255, 0.05);
      color: var(--text-secondary);
      border: 1px solid var(--border-glass);
      font-family: monospace;
    }

    .group-body {
      border-top: 1px solid var(--border-glass);
      background: rgba(0, 0, 0, 0.2);
      padding: 24px;
      display: none;
    }

    .group-body.show {
      display: block;
      animation: slideDown 0.3s ease-out;
    }

    .member-tag {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 16px;
      border-radius: 100px;
      font-size: 0.9em;
      background: rgba(255, 255, 255, 0.03);
      border: 1px solid var(--border-glass);
      margin: 0 8px 8px 0;
      transition: all 0.2s;
    }

    .member-tag:hover {
      background: rgba(255, 255, 255, 0.08);
      border-color: rgba(255, 255, 255, 0.2);
      transform: translateY(-1px);
    }

    .member-tag.is-group {
      color: var(--accent);
      border-color: rgba(139, 92, 246, 0.3);
      background: rgba(139, 92, 246, 0.1);
    }

    .member-tag.is-provider {
      color: var(--warn);
      border-color: rgba(245, 158, 11, 0.3);
      background: rgba(245, 158, 11, 0.1);
      font-style: italic;
    }

    /* Providers Area */
    .provider-card {
      background: rgba(15, 23, 42, 0.4);
      border: 1px solid var(--border-glass);
      border-radius: var(--radius);
      padding: 20px;
      border-left: 5px solid var(--warn);
      transition: all 0.3s;
      margin-bottom: 20px;
    }

    .provider-card:hover {
      transform: translateY(-6px);
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.4);
    }

    /* Modals */
    .modal-overlay {
      background: rgba(10, 14, 23, 0.9);
      backdrop-filter: blur(12px);
      animation: fadeIn 0.3s;
    }

    .modal {
      background: #1e293b;
      border: 1px solid var(--border-glass);
      box-shadow: 0 25px 60px rgba(0, 0, 0, 0.6);
      border-radius: 32px;
      padding: 40px;
      animation: scaleIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
    }

    /* Animations */
    @keyframes fadeIn {
      from {
        opacity: 0;
      }

      to {
        opacity: 1;
      }
    }

    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes scaleIn {
      from {
        opacity: 0;
        transform: scale(0.9);
      }

      to {
        opacity: 1;
        transform: scale(1);
      }
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes slideInLeft {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }

      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* Toast */
    .toast {
      background: rgba(15, 23, 42, 0.95);
      backdrop-filter: blur(16px);
      border: 1px solid var(--border-glass);
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      border-radius: 16px;
      padding: 16px 24px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .toast.success {
      border-left: 4px solid var(--success);
    }

    .toast.error {
      border-left: 4px solid var(--danger);
    }

    /* Typography & Utility */
    h1,
    h2,
    h3 {
      letter-spacing: -0.5px;
    }

    .hidden {
      display: none !important;
    }

    .advanced-toggle {
      color: var(--accent);
      font-weight: 600;
      padding: 10px 0;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .advanced-toggle:hover {
      opacity: 0.8;
      text-decoration: none;
    }

    .yaml-preview {
      background: #0f172a;
      max-height: 500px;
      padding: 24px;
      border-radius: 16px;
      border: 1px solid var(--border-glass);
      font-size: 0.85em;
      color: #cbd5e1;
    }
  </style>
</head>

<body>

  <div class="header">
    <h1>Clash Verge èŠ‚ç‚¹é…ç½®ç¼–è¾‘å™¨</h1>
    <p>å¯è§†åŒ–ç®¡ç†ä»£ç†èŠ‚ç‚¹å’Œç­–ç•¥ç»„ï¼Œæ”¯æŒç²˜è´´åˆ†äº«é“¾æ¥å¿«é€Ÿæ·»åŠ </p>
  </div>

  <div class="container">
    <!-- Import Section -->
    <div class="section" id="importSection">
      <div class="section-title"><i class="ph-bold ph-download-simple"></i> å¯¼å…¥é…ç½®</div>
      <textarea id="importText" placeholder="ç²˜è´´ YAML é…ç½®å†…å®¹..."></textarea>
      <div class="import-actions">
        <button class="btn btn-primary" onclick="parseConfig()">è§£æé…ç½®</button>
        <label class="file-label">
          ğŸ“ ä¸Šä¼  YAML æ–‡ä»¶
          <input type="file" accept=".yaml,.yml" onchange="loadFile(event)">
        </label>
        <button class="btn btn-outline" onclick="startEmpty()">ä»é›¶å¼€å§‹</button>
      </div>
    </div>

    <!-- Editor (hidden until config loaded) -->
    <div id="editorArea" class="hidden">

      <!-- Link Paste Section -->
      <div class="section">
        <div class="section-title"><i class="ph-bold ph-link"></i> ç²˜è´´é“¾æ¥æ·»åŠ èŠ‚ç‚¹</div>
        <div class="link-area">
          <textarea id="linkInput"
            placeholder="ç²˜è´´èŠ‚ç‚¹åˆ†äº«é“¾æ¥ï¼Œæ”¯æŒå¤šè¡Œæ‰¹é‡æ·»åŠ &#10;æ”¯æŒ ss:// vmess:// vless:// trojan:// hysteria2:// hy2://"></textarea>
          <div style="margin-top:10px">
            <button class="btn btn-primary" onclick="parseLinks()">è¯†åˆ«å¹¶æ·»åŠ </button>
          </div>
          <div class="link-results" id="linkResults"></div>
        </div>
      </div>

      <!-- Airport Subscription Section -->
      <div class="section">
        <div class="section-title"><i class="ph-bold ph-airplane-tilt"></i> æœºåœºè®¢é˜…ç®¡ç†</div>
        <div class="airport-area">
          <div style="font-size:.85em;color:var(--text2);margin-bottom:10px">æ·»åŠ æœºåœºè®¢é˜…é“¾æ¥ï¼Œå°†ä½œä¸º proxy-provider å¼•å…¥é…ç½®ï¼Œå¯è¢«ä»£ç†ç»„é€šè¿‡
            use å¼•ç”¨</div>
          <div class="form-group" style="margin-bottom:0">
            <input id="airportUrl" class="provider-url-input" placeholder="ç²˜è´´æœºåœºè®¢é˜…é“¾æ¥ (HTTP/HTTPS URL)">
          </div>
          <div class="airport-form-row">
            <div class="form-group">
              <label>åç§°</label>
              <input id="airportName" placeholder="ä¾‹å¦‚: æˆ‘çš„æœºåœº">
            </div>
            <div class="form-group">
              <label>ç±»å‹</label>
              <select id="airportType">
                <option value="http">http (è¿œç¨‹è®¢é˜…)</option>
                <option value="file">file (æœ¬åœ°æ–‡ä»¶)</option>
              </select>
            </div>
            <div class="form-group" style="flex:0 0 auto;min-width:auto;align-self:flex-end;padding-bottom:2px">
              <label style="display:flex;align-items:center;gap:6px;cursor:pointer;white-space:nowrap">
                <input type="checkbox" id="airportAutoUpdate" checked style="width:auto;accent-color:var(--accent)"
                  onchange="toggleAirportAutoUpdate()"> è‡ªåŠ¨æ›´æ–°
              </label>
            </div>
          </div>
          <div id="airportAutoUpdateFields">
            <div class="airport-form-row">
              <div class="form-group">
                <label>æ›´æ–°é—´éš” (ç§’)</label>
                <input id="airportInterval" type="number" value="86400" placeholder="86400">
              </div>
              <div class="form-group">
                <label>å¥åº·æ£€æŸ¥ URL</label>
                <input id="airportHealthUrl" value="http://www.gstatic.com/generate_204" placeholder="å¥åº·æ£€æŸ¥åœ°å€">
              </div>
              <div class="form-group">
                <label>æ£€æŸ¥é—´éš” (ç§’)</label>
                <input id="airportHealthInterval" type="number" value="300" placeholder="300">
              </div>
            </div>
          </div>
          <div style="margin-top:12px">
            <div class="group-select-title">æ·»åŠ ååŠ å…¥ä»£ç†ç»„ï¼ˆuse å¼•ç”¨ï¼‰ï¼š</div>
            <div class="group-checkboxes" id="airportGroupCheckboxes"></div>
          </div>
          <div style="margin-top:12px">
            <button class="btn btn-primary" onclick="addAirport()">æ·»åŠ è®¢é˜…</button>
          </div>
        </div>
        <div style="margin-top:16px">
          <div style="font-size:.9em;font-weight:600;margin-bottom:8px">å·²æœ‰è®¢é˜…æº (<span id="providerCount">0</span>)</div>
          <div id="providerGrid" class="provider-grid"></div>
        </div>
      </div>

      <!-- Main layout: nodes + form -->
      <div class="main-layout">
        <div>
          <div class="section">
            <div class="section-title" style="justify-content:space-between">
              <span><i class="ph-bold ph-globe-hemisphere-west"></i> ä»£ç†èŠ‚ç‚¹ (<span id="proxyCount">0</span>)</span>
              <button class="btn btn-outline btn-small" onclick="showAddForm()">+ æ‰‹åŠ¨æ·»åŠ </button>
            </div>
            <div id="proxyGrid" class="proxy-grid"></div>
          </div>
        </div>
        <div>
          <div class="section form-section" id="formSection" style="display:none">
            <div class="section-title" id="formTitle">æ·»åŠ èŠ‚ç‚¹</div>
            <div id="formContainer"></div>
          </div>
        </div>
      </div>

      <!-- Proxy Groups -->
      <div class="section">
        <div class="section-title" style="justify-content:space-between">
          <span><i class="ph-bold ph-folder-notch"></i> ä»£ç†ç»„ç®¡ç†</span>
          <button class="btn btn-outline btn-small" onclick="showCreateGroupDialog()">+ æ–°å»ºä»£ç†ç»„</button>
        </div>
        <div id="proxyGroupsList"></div>
      </div>

      <!-- Export -->
      <div class="section">
        <div class="section-title"><i class="ph-bold ph-export"></i> å¯¼å‡ºé…ç½®</div>
        <div class="btn-group">
          <button class="btn btn-success" onclick="exportConfig()">å¯¼å‡º YAML æ–‡ä»¶</button>
          <button class="btn btn-outline" onclick="togglePreview()">é¢„è§ˆ YAML</button>
        </div>
        <div class="yaml-preview-wrap" id="yamlPreviewWrap">
          <button class="copy-btn" onclick="copyYaml()">å¤åˆ¶</button>
          <pre class="yaml-preview" id="yamlPreview"></pre>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal container -->
  <div id="modalContainer"></div>

  <script>
    // ========== Global State ==========
    const AppState = {
      rawConfig: null,
      proxies: [],
      proxyGroups: [],
      proxyProviders: {},
      editingIndex: -1,
      preservedKeys: {}
    };

    // ========== Toast ==========
    function toast(msg, type = 'success') {
      const t = document.createElement('div');
      t.className = 'toast ' + type;
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => { t.style.opacity = '0'; t.style.transition = 'opacity .3s'; setTimeout(() => t.remove(), 300); }, 2500);
    }

    // ========== Modal ==========
    function showModal(title, message, onConfirm) {
      const c = document.getElementById('modalContainer');
      c.innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <h3>${title}</h3>
      <p>${message}</p>
      <div class="btn-group">
        <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-danger" id="modalConfirmBtn">ç¡®è®¤</button>
      </div>
    </div>
  </div>`;
      document.getElementById('modalConfirmBtn').onclick = () => { closeModal(); onConfirm(); };
    }
    function closeModal() { document.getElementById('modalContainer').innerHTML = ''; }

    // ========== Import ==========
    function loadFile(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = ev => { document.getElementById('importText').value = ev.target.result; parseConfig(); };
      reader.readAsText(file);
    }

    function parseConfig() {
      const text = document.getElementById('importText').value.trim();
      if (!text) { toast('è¯·å…ˆç²˜è´´æˆ–ä¸Šä¼ é…ç½®å†…å®¹', 'error'); return; }
      try {
        const doc = jsyaml.load(text);
        if (!doc || typeof doc !== 'object') throw new Error('æ— æ•ˆçš„ YAML');
        AppState.rawConfig = doc;
        AppState.proxies = Array.isArray(doc.proxies) ? doc.proxies : [];
        AppState.proxyGroups = Array.isArray(doc['proxy-groups']) ? doc['proxy-groups'] : [];
        AppState.proxyProviders = doc['proxy-providers'] || {};
        toast('é…ç½®è§£ææˆåŠŸï¼');
        showEditor();
      } catch (e) {
        toast('è§£æå¤±è´¥: ' + e.message, 'error');
      }
    }

    function startEmpty() {
      AppState.rawConfig = {};
      AppState.proxies = [];
      AppState.proxyGroups = [];
      AppState.proxyProviders = {};
      toast('å·²åˆ›å»ºç©ºé…ç½®', 'info');
      showEditor();
    }

    function showEditor() {
      document.getElementById('importSection').classList.add('hidden');
      document.getElementById('editorArea').classList.remove('hidden');
      renderAll();
    }

    function renderAll() {
      renderProxyCards();
      renderProxyGroups();
      renderProviders();
      renderAirportGroupCheckboxes();
    }

    // ========== Share Link Parsing ==========
    function parseShareLink(link) {
      link = link.trim();
      if (!link) return null;
      if (link.startsWith('hysteria2://') || link.startsWith('hy2://')) return parseHysteria2Link(link);
      if (link.startsWith('vless://')) return parseVlessLink(link);
      if (link.startsWith('vmess://')) return parseVmessLink(link);
      if (link.startsWith('trojan://')) return parseTrojanLink(link);
      if (link.startsWith('ss://')) return parseSsLink(link);
      return null;
    }

    function parseHysteria2Link(link) {
      try {
        const normalized = link.replace(/^hy2:\/\//, 'hysteria2://');
        const url = new URL(normalized);
        const params = url.searchParams;
        const node = { type: 'hysteria2', name: decodeURIComponent(url.hash.slice(1)) || 'Hysteria2èŠ‚ç‚¹', server: url.hostname, port: parseInt(url.port) || 443, password: decodeURIComponent(url.username) };
        if (params.get('sni')) node.sni = params.get('sni');
        if (params.get('insecure') === '1') node['skip-cert-verify'] = true;
        if (params.get('obfs')) node.obfs = params.get('obfs');
        if (params.get('obfs-password')) node['obfs-password'] = params.get('obfs-password');
        return node;
      } catch (e) { return null; }
    }

    function parseVlessLink(link) {
      try {
        const url = new URL(link);
        const params = url.searchParams;
        const node = { type: 'vless', name: decodeURIComponent(url.hash.slice(1)) || 'VLESSèŠ‚ç‚¹', server: url.hostname, port: parseInt(url.port) || 443, uuid: decodeURIComponent(url.username), udp: true };
        const security = params.get('security') || 'none';
        if (security === 'tls' || security === 'reality') node.tls = true;
        if (params.get('sni')) node.servername = params.get('sni');
        if (params.get('fp')) node['client-fingerprint'] = params.get('fp');
        if (params.get('flow')) node.flow = params.get('flow');
        const netType = params.get('type') || 'tcp';
        if (netType !== 'tcp') node.network = netType;
        if (security === 'reality') {
          node['reality-opts'] = {};
          if (params.get('pbk')) node['reality-opts']['public-key'] = params.get('pbk');
          if (params.get('sid')) node['reality-opts']['short-id'] = params.get('sid');
        }
        if (netType === 'ws') {
          node['ws-opts'] = {};
          if (params.get('path')) node['ws-opts'].path = params.get('path');
          if (params.get('host')) node['ws-opts'].headers = { Host: params.get('host') };
        }
        if (netType === 'grpc') {
          node['grpc-opts'] = {};
          if (params.get('serviceName')) node['grpc-opts']['grpc-service-name'] = params.get('serviceName');
        }
        if (params.get('insecure') === '1') node['skip-cert-verify'] = true;
        return node;
      } catch (e) { return null; }
    }

    function parseVmessLink(link) {
      try {
        const b64 = link.replace('vmess://', '');
        const decoded = atob(b64.replace(/-/g, '+').replace(/_/g, '/'));
        const json = JSON.parse(decoded);
        const node = { type: 'vmess', name: json.ps || 'VMessèŠ‚ç‚¹', server: json.add, port: parseInt(json.port), uuid: json.id, alterId: parseInt(json.aid) || 0, cipher: json.scy || 'auto' };
        if (json.net && json.net !== 'tcp') node.network = json.net;
        if (json.tls === 'tls') { node.tls = true; if (json.sni) node.servername = json.sni; }
        if (json['skip-cert-verify']) node['skip-cert-verify'] = true;
        if (json.net === 'ws') {
          node['ws-opts'] = {};
          if (json.path) node['ws-opts'].path = json.path;
          if (json.host) node['ws-opts'].headers = { Host: json.host };
        }
        if (json.fp) node['client-fingerprint'] = json.fp;
        return node;
      } catch (e) { return null; }
    }

    function parseTrojanLink(link) {
      try {
        const url = new URL(link);
        const params = url.searchParams;
        const node = { type: 'trojan', name: decodeURIComponent(url.hash.slice(1)) || 'TrojanèŠ‚ç‚¹', server: url.hostname, port: parseInt(url.port) || 443, password: decodeURIComponent(url.username) };
        if (params.get('sni')) node.sni = params.get('sni');
        if (params.get('insecure') === '1' || params.get('allowInsecure') === '1') node['skip-cert-verify'] = true;
        const netType = params.get('type') || 'tcp';
        if (netType !== 'tcp') node.network = netType;
        if (netType === 'ws') {
          node['ws-opts'] = {};
          if (params.get('path')) node['ws-opts'].path = params.get('path');
          if (params.get('host')) node['ws-opts'].headers = { Host: params.get('host') };
        }
        return node;
      } catch (e) { return null; }
    }

    function parseSsLink(link) {
      try {
        let rest = link.replace('ss://', '');
        let name = '';
        const hashIdx = rest.indexOf('#');
        if (hashIdx !== -1) { name = decodeURIComponent(rest.slice(hashIdx + 1)); rest = rest.slice(0, hashIdx); }
        // SIP002 format: base64(method:password)@host:port
        const atIdx = rest.indexOf('@');
        let method, password, server, port;
        if (atIdx !== -1) {
          const userinfo = rest.slice(0, atIdx);
          const hostport = rest.slice(atIdx + 1).split('?')[0];
          let decoded;
          try { decoded = atob(userinfo.replace(/-/g, '+').replace(/_/g, '/')); } catch (e) { decoded = decodeURIComponent(userinfo); }
          const colonIdx = decoded.indexOf(':');
          method = decoded.slice(0, colonIdx);
          password = decoded.slice(colonIdx + 1);
          const lastColon = hostport.lastIndexOf(':');
          server = hostport.slice(0, lastColon);
          port = parseInt(hostport.slice(lastColon + 1));
        } else {
          // Legacy format: base64(method:password@host:port)
          let decoded;
          try { decoded = atob(rest.replace(/-/g, '+').replace(/_/g, '/')); } catch (e) { decoded = rest; }
          const atIdx2 = decoded.indexOf('@');
          const colonIdx = decoded.indexOf(':');
          method = decoded.slice(0, colonIdx);
          password = decoded.slice(colonIdx + 1, atIdx2);
          const hostport = decoded.slice(atIdx2 + 1);
          const lastColon = hostport.lastIndexOf(':');
          server = hostport.slice(0, lastColon);
          port = parseInt(hostport.slice(lastColon + 1));
        }
        return { type: 'ss', name: name || 'SSèŠ‚ç‚¹', server, port, cipher: method, password };
      } catch (e) { return null; }
    }

    // ========== Link Parsing UI ==========
    function parseLinks() {
      const text = document.getElementById('linkInput').value.trim();
      if (!text) { toast('è¯·å…ˆç²˜è´´èŠ‚ç‚¹é“¾æ¥', 'error'); return; }
      const lines = text.split('\n').map(l => l.trim()).filter(Boolean);
      const results = [];
      lines.forEach((line, i) => {
        const node = parseShareLink(line);
        results.push({ line, node, index: i });
      });
      renderLinkResults(results);
    }

    function renderLinkResults(results) {
      const container = document.getElementById('linkResults');
      if (!results.length) { container.innerHTML = ''; return; }
      let html = '<div style="margin-bottom:12px;font-size:.9em;color:var(--text2)">è¯†åˆ«åˆ° ' + results.filter(r => r.node).length + ' / ' + results.length + ' ä¸ªèŠ‚ç‚¹</div>';
      results.forEach((r, idx) => {
        if (!r.node) {
          html += `<div class="link-card error"><div class="link-card-header"><span class="badge badge-error">å¤±è´¥</span><span style="font-size:.85em;color:var(--danger)">æ— æ³•è¯†åˆ«: ${escHtml(r.line.substring(0, 60))}...</span></div></div>`;
          return;
        }
        const n = r.node;
        const typeClass = n.type === 'hy2' ? 'hysteria2' : n.type;
        html += `<div class="link-card" data-result-idx="${idx}">
      <div class="link-card-header">
        <span class="badge badge-${typeClass}">${n.type}</span>
        <strong>${escHtml(n.name)}</strong>
      </div>
      <div class="link-card-info">
        <span>æœåŠ¡å™¨: ${escHtml(n.server)}</span>
        <span>ç«¯å£: ${n.port}</span>
      </div>
      <div class="group-select">
        <div class="group-select-title">åŠ å…¥ç°æœ‰åˆ†ç»„ï¼š</div>
        <div class="group-checkboxes">`;
        AppState.proxyGroups.forEach((g, gi) => {
          html += `<label><input type="checkbox" class="link-group-cb" data-result="${idx}" data-group="${gi}"> ${escHtml(g.name)}</label>`;
        });
        if (!AppState.proxyGroups.length) html += '<span style="color:var(--text2);font-size:.85em">æš‚æ— ä»£ç†ç»„</span>';
        html += `</div>
        <button class="new-group-toggle" onclick="toggleNewGroupInLink(${idx})">+ æ–°å»ºåˆ†ç»„å¹¶åŠ å…¥</button>
        <div class="new-group-form hidden" id="newGroupForm_${idx}">
          <div class="form-row">
            <input placeholder="ç»„å" id="newGroupName_${idx}">
            <select id="newGroupType_${idx}"><option value="select">select</option><option value="url-test">url-test</option><option value="fallback">fallback</option><option value="load-balance">load-balance</option></select>
          </div>
          <div class="form-row">
            <select id="newGroupParent_${idx}"><option value="">ä¸åµŒå¥—</option>`;
        AppState.proxyGroups.forEach((g, gi) => { html += `<option value="${gi}">${escHtml(g.name)}</option>`; });
        html += `</select>
          </div>
        </div>
      </div>
    </div>`;
      });
      html += `<div style="margin-top:16px"><button class="btn btn-success" onclick="confirmAddLinks()">ç¡®è®¤æ·»åŠ </button></div>`;
      container.innerHTML = html;
      // Store results for later
      container._results = results;
    }

    function toggleNewGroupInLink(idx) {
      const el = document.getElementById('newGroupForm_' + idx);
      el.classList.toggle('hidden');
    }

    function confirmAddLinks() {
      const container = document.getElementById('linkResults');
      const results = container._results;
      if (!results) return;
      let addedCount = 0;
      results.forEach((r, idx) => {
        if (!r.node) return;
        const node = r.node;
        AppState.proxies.push(node);
        addedCount++;
        // Add to checked groups
        document.querySelectorAll(`.link-group-cb[data-result="${idx}"]:checked`).forEach(cb => {
          const gi = parseInt(cb.dataset.group);
          if (AppState.proxyGroups[gi]) {
            if (!AppState.proxyGroups[gi].proxies) AppState.proxyGroups[gi].proxies = [];
            if (!AppState.proxyGroups[gi].proxies.includes(node.name)) {
              AppState.proxyGroups[gi].proxies.push(node.name);
            }
          }
        });
        // Create new group if specified
        const nameEl = document.getElementById('newGroupName_' + idx);
        const typeEl = document.getElementById('newGroupType_' + idx);
        const parentEl = document.getElementById('newGroupParent_' + idx);
        if (nameEl && nameEl.value.trim()) {
          const newGroup = { name: nameEl.value.trim(), type: typeEl.value, proxies: [node.name] };
          if (typeEl.value === 'url-test' || typeEl.value === 'fallback') {
            newGroup.url = 'http://www.gstatic.com/generate_204';
            newGroup.interval = 300;
          }
          AppState.proxyGroups.push(newGroup);
          // Nest into parent if selected
          if (parentEl.value !== '') {
            const pi = parseInt(parentEl.value);
            if (AppState.proxyGroups[pi]) {
              if (!AppState.proxyGroups[pi].proxies) AppState.proxyGroups[pi].proxies = [];
              if (!AppState.proxyGroups[pi].proxies.includes(newGroup.name)) {
                AppState.proxyGroups[pi].proxies.push(newGroup.name);
              }
            }
          }
        }
      });
      if (addedCount) {
        toast(`æˆåŠŸæ·»åŠ  ${addedCount} ä¸ªèŠ‚ç‚¹`);
        document.getElementById('linkInput').value = '';
        container.innerHTML = '';
        renderAll();
      } else {
        toast('æ²¡æœ‰å¯æ·»åŠ çš„èŠ‚ç‚¹', 'error');
      }
    }

    // ========== Proxy Cards ==========
    function renderProxyCards() {
      const grid = document.getElementById('proxyGrid');
      document.getElementById('proxyCount').textContent = AppState.proxies.length;
      if (!AppState.proxies.length) {
        grid.innerHTML = '<div class="empty-state"><p>æš‚æ— ä»£ç†èŠ‚ç‚¹</p><p>å¯ä»¥é€šè¿‡ä¸Šæ–¹ç²˜è´´é“¾æ¥æˆ–æ‰‹åŠ¨æ·»åŠ </p></div>';
        return;
      }
      grid.innerHTML = AppState.proxies.map((p, i) => {
        const t = p.type || 'unknown';
        return `<div class="proxy-card" data-type="${t}">
      <div class="proxy-card-name">
        <span>${escHtml(p.name || 'æœªå‘½å')}</span>
        <span class="badge badge-${t === 'hy2' ? 'hysteria2' : t}">${t}</span>
      </div>
      <div class="proxy-card-detail">${escHtml(p.server || '')}:${p.port || ''}</div>
      <div class="proxy-card-actions">
        <button class="btn btn-outline btn-small" onclick="editProxy(${i})">ç¼–è¾‘</button>
        <button class="btn btn-danger btn-small" onclick="deleteProxy(${i})">åˆ é™¤</button>
      </div>
    </div>`;
      }).join('');
    }

    // ========== Add / Edit Form ==========
    function showAddForm() {
      AppState.editingIndex = -1;
      document.getElementById('formTitle').textContent = 'æ·»åŠ èŠ‚ç‚¹';
      document.getElementById('formSection').style.display = '';
      buildForm('hysteria2');
    }

    function editProxy(idx) {
      AppState.editingIndex = idx;
      const p = AppState.proxies[idx];
      document.getElementById('formTitle').textContent = 'ç¼–è¾‘èŠ‚ç‚¹';
      document.getElementById('formSection').style.display = '';
      buildForm(p.type, p);
    }

    function buildForm(type, data) {
      const d = data || {};
      const isEdit = AppState.editingIndex >= 0;
      const typeOptions = ['ss', 'vmess', 'trojan', 'hysteria2', 'vless'].map(t =>
        `<option value="${t}" ${type === t ? 'selected' : ''}>${t}</option>`).join('');

      let html = `<div class="form-group"><label class="required">ä»£ç†ç±»å‹</label><select id="f_type" onchange="buildForm(this.value, null)">${typeOptions}</select></div>`;
      html += `<div class="form-group"><label class="required">åç§°</label><input id="f_name" value="${escAttr(d.name || '')}"></div>`;
      html += `<div class="form-group"><label class="required">æœåŠ¡å™¨</label><input id="f_server" value="${escAttr(d.server || '')}"></div>`;
      html += `<div class="form-group"><label class="required">ç«¯å£</label><input id="f_port" type="number" value="${d.port || ''}"></div>`;

      if (type === 'ss') {
        const ciphers = ['aes-128-gcm', 'aes-256-gcm', 'chacha20-ietf-poly1305', '2022-blake3-aes-128-gcm', '2022-blake3-aes-256-gcm', '2022-blake3-chacha20-poly1305'];
        html += `<div class="form-group"><label class="required">åŠ å¯†æ–¹å¼</label><select id="f_cipher">${ciphers.map(c => `<option ${d.cipher === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>`;
        html += `<div class="form-group"><label class="required">å¯†ç </label><input id="f_password" value="${escAttr(d.password || '')}"></div>`;
        html += advancedStart();
        html += checkboxField('f_udp', 'UDP', d.udp);
        html += advancedEnd();
      }

      if (type === 'vmess') {
        html += `<div class="form-group"><label class="required">UUID</label><input id="f_uuid" value="${escAttr(d.uuid || '')}"></div>`;
        html += `<div class="form-group"><label>alterId</label><input id="f_alterId" type="number" value="${d.alterId || 0}"></div>`;
        const vmCiphers = ['auto', 'aes-128-gcm', 'chacha20-poly1305', 'none'];
        html += `<div class="form-group"><label>åŠ å¯†æ–¹å¼</label><select id="f_cipher">${vmCiphers.map(c => `<option ${d.cipher === c ? 'selected' : ''}>${c}</option>`).join('')}</select></div>`;
        html += advancedStart();
        html += checkboxField('f_tls', 'TLS', d.tls);
        html += checkboxField('f_skip_cert', 'è·³è¿‡è¯ä¹¦éªŒè¯', d['skip-cert-verify']);
        html += `<div class="form-group"><label>servername (SNI)</label><input id="f_servername" value="${escAttr(d.servername || '')}"></div>`;
        html += networkFields(d);
        html += advancedEnd();
      }

      if (type === 'trojan') {
        html += `<div class="form-group"><label class="required">å¯†ç </label><input id="f_password" value="${escAttr(d.password || '')}"></div>`;
        html += advancedStart();
        html += `<div class="form-group"><label>SNI</label><input id="f_sni" value="${escAttr(d.sni || '')}"></div>`;
        html += checkboxField('f_skip_cert', 'è·³è¿‡è¯ä¹¦éªŒè¯', d['skip-cert-verify']);
        html += networkFields(d);
        html += advancedEnd();
      }

      if (type === 'hysteria2') {
        html += `<div class="form-group"><label class="required">å¯†ç </label><input id="f_password" value="${escAttr(d.password || '')}"></div>`;
        html += advancedStart();
        html += `<div class="form-group"><label>SNI</label><input id="f_sni" value="${escAttr(d.sni || '')}"></div>`;
        html += checkboxField('f_skip_cert', 'è·³è¿‡è¯ä¹¦éªŒè¯', d['skip-cert-verify']);
        html += checkboxField('f_udp', 'UDP', d.udp);
        html += `<div class="form-group"><label>ä¸Šè¡Œå¸¦å®½ (up)</label><input id="f_up" value="${escAttr(d.up || '')}"></div>`;
        html += `<div class="form-group"><label>ä¸‹è¡Œå¸¦å®½ (down)</label><input id="f_down" value="${escAttr(d.down || '')}"></div>`;
        html += `<div class="form-group"><label>obfs</label><input id="f_obfs" value="${escAttr(d.obfs || '')}"></div>`;
        html += `<div class="form-group"><label>obfs-password</label><input id="f_obfs_password" value="${escAttr(d['obfs-password'] || '')}"></div>`;
        html += advancedEnd();
      }

      if (type === 'vless') {
        html += `<div class="form-group"><label class="required">UUID</label><input id="f_uuid" value="${escAttr(d.uuid || '')}"></div>`;
        html += advancedStart();
        const flows = ['', 'xtls-rprx-vision', 'xtls-rprx-direct'];
        html += `<div class="form-group"><label>Flow</label><select id="f_flow">${flows.map(f => `<option value="${f}" ${d.flow === f ? 'selected' : ''}>${f || 'æ— '}</option>`).join('')}</select></div>`;
        html += checkboxField('f_tls', 'TLS', d.tls);
        html += `<div class="form-group"><label>servername (SNI)</label><input id="f_servername" value="${escAttr(d.servername || '')}"></div>`;
        const fps = ['', 'chrome', 'firefox', 'safari', 'ios', 'android', 'edge', '360', 'qq', 'random', 'randomized'];
        html += `<div class="form-group"><label>client-fingerprint</label><select id="f_fp">${fps.map(f => `<option value="${f}" ${d['client-fingerprint'] === f ? 'selected' : ''}>${f || 'é»˜è®¤'}</option>`).join('')}</select></div>`;
        html += checkboxField('f_udp', 'UDP', d.udp !== false);
        html += networkFields(d);
        html += `<div class="form-group"><label>Reality public-key</label><input id="f_reality_pk" value="${escAttr((d['reality-opts'] || {})['public-key'] || '')}"></div>`;
        html += `<div class="form-group"><label>Reality short-id</label><input id="f_reality_sid" value="${escAttr((d['reality-opts'] || {})['short-id'] || '')}"></div>`;
        html += advancedEnd();
      }

      // Group selection for save
      html += `<div class="form-group-select">
    <div style="font-size:.85em;font-weight:600;margin-bottom:8px;color:var(--text2)">ä¿å­˜ååŠ å…¥åˆ†ç»„ï¼ˆå¯é€‰ï¼‰ï¼š</div>
    <div class="group-checkboxes">`;
      AppState.proxyGroups.forEach((g, gi) => {
        const checked = isEdit && g.proxies && g.proxies.includes(d.name) ? 'checked' : '';
        html += `<label><input type="checkbox" class="form-group-cb" data-group="${gi}" ${checked}> ${escHtml(g.name)}</label>`;
      });
      html += `</div></div>`;
      html += `<div style="margin-top:16px" class="btn-group">
    <button class="btn btn-primary" onclick="saveProxy()">ä¿å­˜</button>
    <button class="btn btn-outline" onclick="cancelForm()">å–æ¶ˆ</button>
  </div>`;

      document.getElementById('formContainer').innerHTML = html;
    }

    function advancedStart() {
      return `<button class="advanced-toggle" onclick="this.nextElementSibling.classList.toggle('show');this.textContent=this.nextElementSibling.classList.contains('show')?'â–¼ æ”¶èµ·é«˜çº§é€‰é¡¹':'â–¶ é«˜çº§é€‰é¡¹'">â–¶ é«˜çº§é€‰é¡¹</button><div class="advanced-fields">`;
    }
    function advancedEnd() { return '</div>'; }

    function checkboxField(id, label, checked) {
      return `<div class="form-group"><label><input type="checkbox" id="${id}" ${checked ? 'checked' : ''} style="width:auto;margin-right:6px"> ${label}</label></div>`;
    }

    function networkFields(d) {
      const nets = ['tcp', 'ws', 'grpc', 'h2'];
      const curNet = d.network || 'tcp';
      let html = `<div class="form-group"><label>ä¼ è¾“æ–¹å¼</label><select id="f_network">${nets.map(n => `<option value="${n}" ${curNet === n ? 'selected' : ''}>${n}</option>`).join('')}</select></div>`;
      html += `<div class="form-group"><label>ws-opts path</label><input id="f_ws_path" value="${escAttr((d['ws-opts'] || {}).path || '')}"></div>`;
      html += `<div class="form-group"><label>ws-opts host</label><input id="f_ws_host" value="${escAttr(((d['ws-opts'] || {}).headers || {}).Host || '')}"></div>`;
      return html;
    }

    function cancelForm() {
      document.getElementById('formSection').style.display = 'none';
      AppState.editingIndex = -1;
    }

    function saveProxy() {
      const type = val('f_type');
      const name = val('f_name');
      const server = val('f_server');
      const port = intVal('f_port');
      if (!name || !server || !port) { toast('è¯·å¡«å†™åç§°ã€æœåŠ¡å™¨å’Œç«¯å£', 'error'); return; }

      const node = { type, name, server, port };
      const isEdit = AppState.editingIndex >= 0;
      const oldName = isEdit ? AppState.proxies[AppState.editingIndex].name : null;

      // Preserve unknown fields from original node when editing
      if (isEdit) {
        const orig = AppState.proxies[AppState.editingIndex];
        Object.keys(orig).forEach(k => {
          if (!(k in node)) node[k] = orig[k];
        });
      }

      if (type === 'ss') {
        node.cipher = val('f_cipher'); node.password = val('f_password');
        if (el('f_udp') && el('f_udp').checked) node.udp = true;
      }
      if (type === 'vmess') {
        node.uuid = val('f_uuid'); node.alterId = intVal('f_alterId') || 0; node.cipher = val('f_cipher');
        if (el('f_tls') && el('f_tls').checked) node.tls = true;
        if (el('f_skip_cert') && el('f_skip_cert').checked) node['skip-cert-verify'] = true;
        if (val('f_servername')) node.servername = val('f_servername');
        applyNetworkFields(node);
      }
      if (type === 'trojan') {
        node.password = val('f_password');
        if (val('f_sni')) node.sni = val('f_sni');
        if (el('f_skip_cert') && el('f_skip_cert').checked) node['skip-cert-verify'] = true;
        applyNetworkFields(node);
      }
      if (type === 'hysteria2') {
        node.password = val('f_password');
        if (val('f_sni')) node.sni = val('f_sni');
        if (el('f_skip_cert') && el('f_skip_cert').checked) node['skip-cert-verify'] = true;
        if (el('f_udp') && el('f_udp').checked) node.udp = true;
        if (val('f_up')) node.up = val('f_up');
        if (val('f_down')) node.down = val('f_down');
        if (val('f_obfs')) node.obfs = val('f_obfs');
        if (val('f_obfs_password')) node['obfs-password'] = val('f_obfs_password');
      }
      if (type === 'vless') {
        node.uuid = val('f_uuid');
        if (val('f_flow')) node.flow = val('f_flow');
        if (el('f_tls') && el('f_tls').checked) node.tls = true;
        if (val('f_servername')) node.servername = val('f_servername');
        if (val('f_fp')) node['client-fingerprint'] = val('f_fp');
        if (el('f_udp') && el('f_udp').checked) node.udp = true;
        applyNetworkFields(node);
        if (val('f_reality_pk')) {
          node['reality-opts'] = { 'public-key': val('f_reality_pk') };
          if (val('f_reality_sid')) node['reality-opts']['short-id'] = val('f_reality_sid');
        }
      }

      if (isEdit) {
        // Remove fields from the old type that don't apply
        const keepFields = Object.keys(node);
        AppState.proxies[AppState.editingIndex] = node;
        // Sync name in groups
        if (oldName !== name) {
          AppState.proxyGroups.forEach(g => {
            if (g.proxies) {
              const idx = g.proxies.indexOf(oldName);
              if (idx !== -1) g.proxies[idx] = name;
            }
          });
        }
      } else {
        AppState.proxies.push(node);
      }

      // Update group membership from checkboxes
      document.querySelectorAll('.form-group-cb').forEach(cb => {
        const gi = parseInt(cb.dataset.group);
        const g = AppState.proxyGroups[gi];
        if (!g) return;
        if (!g.proxies) g.proxies = [];
        const inGroup = g.proxies.includes(name);
        if (cb.checked && !inGroup) g.proxies.push(name);
        if (!cb.checked && inGroup) g.proxies = g.proxies.filter(n => n !== name);
        // Also clean old name if renamed
        if (isEdit && oldName !== name) {
          g.proxies = g.proxies.filter(n => n !== oldName);
        }
      });

      toast(isEdit ? 'èŠ‚ç‚¹å·²æ›´æ–°' : 'èŠ‚ç‚¹å·²æ·»åŠ ');
      cancelForm();
      renderAll();
    }

    function applyNetworkFields(node) {
      const net = val('f_network');
      if (net && net !== 'tcp') node.network = net;
      if (val('f_ws_path') || val('f_ws_host')) {
        node['ws-opts'] = {};
        if (val('f_ws_path')) node['ws-opts'].path = val('f_ws_path');
        if (val('f_ws_host')) node['ws-opts'].headers = { Host: val('f_ws_host') };
      }
    }

    function deleteProxy(idx) {
      const name = AppState.proxies[idx].name;
      showModal('åˆ é™¤èŠ‚ç‚¹', `ç¡®å®šè¦åˆ é™¤èŠ‚ç‚¹ "${escHtml(name)}" å—ï¼Ÿå°†åŒæ—¶ä»æ‰€æœ‰ä»£ç†ç»„ä¸­ç§»é™¤ã€‚`, () => {
        AppState.proxies.splice(idx, 1);
        AppState.proxyGroups.forEach(g => {
          if (g.proxies) g.proxies = g.proxies.filter(n => n !== name);
        });
        if (AppState.editingIndex === idx) cancelForm();
        else if (AppState.editingIndex > idx) AppState.editingIndex--;
        toast('èŠ‚ç‚¹å·²åˆ é™¤');
        renderAll();
      });
    }

    // ========== Proxy Groups ==========
    function renderProxyGroups() {
      const list = document.getElementById('proxyGroupsList');
      if (!AppState.proxyGroups.length) {
        list.innerHTML = '<div class="empty-state"><p>æš‚æ— ä»£ç†ç»„</p></div>';
        return;
      }
      const allNames = AppState.proxies.map(p => p.name);
      const groupNames = AppState.proxyGroups.map(g => g.name);
      // provider names
      const providerNames = Object.keys(AppState.proxyProviders);

      list.innerHTML = AppState.proxyGroups.map((g, gi) => {
        const members = g.proxies || [];
        const useProviders = g.use || [];
        let membersHtml = members.map(m => {
          const isGrp = groupNames.includes(m);
          return `<span class="member-tag ${isGrp ? 'is-group' : ''}">
        ${escHtml(m)}
        <button class="remove-member" onclick="removeMember(${gi},'${escAttr(m)}')" title="ç§»é™¤">&times;</button>
      </span>`;
        }).join('');
        // Show use (providers) as read-only tags
        membersHtml += useProviders.map(u =>
          `<span class="member-tag is-provider">${escHtml(u)} (provider)</span>`).join('');
        if (!members.length && !useProviders.length) membersHtml = '<span style="color:var(--text2);font-size:.85em">æ— æˆå‘˜</span>';

        // Build options for add-member dropdown
        let options = '<option value="">é€‰æ‹©æ·»åŠ ...</option>';
        allNames.forEach(n => {
          if (!members.includes(n)) options += `<option value="proxy:${escAttr(n)}">[èŠ‚ç‚¹] ${escHtml(n)}</option>`;
        });
        groupNames.forEach((n, i) => {
          if (i !== gi && !members.includes(n)) options += `<option value="group:${escAttr(n)}">[åˆ†ç»„] ${escHtml(n)}</option>`;
        });

        return `<div class="group-item">
      <div class="group-header" onclick="toggleGroup(${gi})">
        <span class="arrow" id="arrow_${gi}">â–¶</span>
        <span class="group-name">${escHtml(g.name)}</span>
        <span class="group-type-badge">${g.type}</span>
        <span style="font-size:.8em;color:var(--text2)">${members.length} ä¸ªæˆå‘˜</span>
        <button class="btn btn-danger btn-small" onclick="event.stopPropagation();deleteGroup(${gi})" style="margin-left:auto">åˆ é™¤ç»„</button>
      </div>
      <div class="group-body" id="groupBody_${gi}">
        <div class="group-members">${membersHtml}</div>
        <div class="add-member-row">
          <select id="addMemberSelect_${gi}">${options}</select>
          <button class="btn btn-outline btn-small" onclick="addMember(${gi})">æ·»åŠ </button>
        </div>
      </div>
    </div>`;
      }).join('');
    }

    function toggleGroup(gi) {
      const body = document.getElementById('groupBody_' + gi);
      const arrow = document.getElementById('arrow_' + gi);
      body.classList.toggle('show');
      arrow.classList.toggle('open');
    }

    function removeMember(gi, name) {
      const g = AppState.proxyGroups[gi];
      if (g.proxies) g.proxies = g.proxies.filter(n => n !== name);
      renderProxyGroups();
      // Keep this group open
      document.getElementById('groupBody_' + gi).classList.add('show');
      document.getElementById('arrow_' + gi).classList.add('open');
    }

    function addMember(gi) {
      const sel = document.getElementById('addMemberSelect_' + gi);
      if (!sel.value) return;
      const name = sel.value.replace(/^(proxy|group):/, '');
      const g = AppState.proxyGroups[gi];
      if (!g.proxies) g.proxies = [];
      if (!g.proxies.includes(name)) {
        g.proxies.push(name);
        renderProxyGroups();
        // Re-open this group
        document.getElementById('groupBody_' + gi).classList.add('show');
        document.getElementById('arrow_' + gi).classList.add('open');
      }
    }

    function deleteGroup(gi) {
      const name = AppState.proxyGroups[gi].name;
      showModal('åˆ é™¤ä»£ç†ç»„', `ç¡®å®šè¦åˆ é™¤ä»£ç†ç»„ "${escHtml(name)}" å—ï¼Ÿå°†ä»å…¶ä»–ç»„ä¸­ç§»é™¤å¯¹å®ƒçš„å¼•ç”¨ã€‚`, () => {
        AppState.proxyGroups.splice(gi, 1);
        // Clean references
        AppState.proxyGroups.forEach(g => {
          if (g.proxies) g.proxies = g.proxies.filter(n => n !== name);
        });
        toast('ä»£ç†ç»„å·²åˆ é™¤');
        renderProxyGroups();
      });
    }

    function showCreateGroupDialog() {
      const c = document.getElementById('modalContainer');
      let parentOpts = '<option value="">ä¸åµŒå¥—</option>';
      AppState.proxyGroups.forEach((g, i) => { parentOpts += `<option value="${i}">${escHtml(g.name)}</option>`; });
      c.innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal">
      <h3>æ–°å»ºä»£ç†ç»„</h3>
      <div class="form-group"><label class="required">ç»„å</label><input id="cg_name"></div>
      <div class="form-group"><label>ç±»å‹</label><select id="cg_type">
        <option value="select">select</option><option value="url-test">url-test</option>
        <option value="fallback">fallback</option><option value="load-balance">load-balance</option>
      </select></div>
      <div class="form-group"><label>åµŒå¥—åˆ°çˆ¶ç»„</label><select id="cg_parent">${parentOpts}</select></div>
      <div class="btn-group" style="margin-top:16px">
        <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="createGroupFromDialog()">åˆ›å»º</button>
      </div>
    </div>
  </div>`;
    }

    function createGroupFromDialog() {
      const name = document.getElementById('cg_name').value.trim();
      if (!name) { toast('è¯·è¾“å…¥ç»„å', 'error'); return; }
      if (AppState.proxyGroups.some(g => g.name === name)) { toast('ç»„åå·²å­˜åœ¨', 'error'); return; }
      const type = document.getElementById('cg_type').value;
      const parentVal = document.getElementById('cg_parent').value;
      const newGroup = { name, type, proxies: [] };
      if (type === 'url-test' || type === 'fallback') {
        newGroup.url = 'http://www.gstatic.com/generate_204';
        newGroup.interval = 300;
      }
      AppState.proxyGroups.push(newGroup);
      if (parentVal !== '') {
        const pi = parseInt(parentVal);
        if (AppState.proxyGroups[pi]) {
          if (!AppState.proxyGroups[pi].proxies) AppState.proxyGroups[pi].proxies = [];
          AppState.proxyGroups[pi].proxies.push(name);
        }
      }
      closeModal();
      toast('ä»£ç†ç»„å·²åˆ›å»º');
      renderProxyGroups();
    }

    // ========== Export ==========

    // ========== Airport / Proxy Providers ==========
    function toggleAirportAutoUpdate() {
      const checked = document.getElementById('airportAutoUpdate').checked;
      document.getElementById('airportAutoUpdateFields').style.display = checked ? '' : 'none';
    }

    function renderAirportGroupCheckboxes() {
      const container = document.getElementById('airportGroupCheckboxes');
      if (!container) return;
      if (!AppState.proxyGroups.length) {
        container.innerHTML = '<span style="color:var(--text2);font-size:.85em">æš‚æ— ä»£ç†ç»„</span>';
        return;
      }
      container.innerHTML = AppState.proxyGroups.map((g, gi) =>
        `<label><input type="checkbox" class="airport-group-cb" data-group="${gi}"> ${escHtml(g.name)}</label>`
      ).join('');
    }

    function renderProviders() {
      const grid = document.getElementById('providerGrid');
      const countEl = document.getElementById('providerCount');
      if (!grid) return;
      const names = Object.keys(AppState.proxyProviders);
      countEl.textContent = names.length;
      if (!names.length) {
        grid.innerHTML = '<div class="empty-state"><p>æš‚æ— è®¢é˜…æº</p></div>';
        return;
      }
      const groupNames = AppState.proxyGroups.map(g => g.name);
      grid.innerHTML = names.map(name => {
        const p = AppState.proxyProviders[name];
        const url = p.url || p.path || '';
        const pType = p.type || 'http';
        const interval = p.interval || '';
        const hc = p['health-check'] || {};
        // Find which groups use this provider
        const usedBy = AppState.proxyGroups.filter(g => g.use && g.use.includes(name)).map(g => g.name);
        return `<div class="provider-card">
      <div class="provider-card-name">
        <span>${escHtml(name)}</span>
        <span class="badge" style="background:var(--warn)">${pType}</span>
      </div>
      <div class="provider-card-detail">${escHtml(url)}</div>
      ${interval ? `<div class="provider-card-detail">æ›´æ–°é—´éš”: ${interval}s</div>` : ''}
      ${hc.url ? `<div class="provider-card-detail">å¥åº·æ£€æŸ¥: ${escHtml(hc.url)} (${hc.interval || 300}s)</div>` : ''}
      <div class="provider-use-groups">
        <div class="group-select-title">è¢«ä»¥ä¸‹ä»£ç†ç»„å¼•ç”¨ (use)ï¼š</div>
        <div class="group-checkboxes">
          ${AppState.proxyGroups.map((g, gi) => {
          const checked = g.use && g.use.includes(name) ? 'checked' : '';
          return `<label><input type="checkbox" ${checked} onchange="toggleProviderUse('${escAttr(name)}',${gi},this.checked)"> ${escHtml(g.name)}</label>`;
        }).join('')}
        </div>
      </div>
      <div class="provider-card-actions">
        <button class="btn btn-outline btn-small" onclick="editProvider('${escAttr(name)}')">ç¼–è¾‘</button>
        <button class="btn btn-danger btn-small" onclick="deleteProvider('${escAttr(name)}')">åˆ é™¤</button>
      </div>
    </div>`;
      }).join('');
    }

    function addAirport() {
      const url = document.getElementById('airportUrl').value.trim();
      const name = document.getElementById('airportName').value.trim();
      const type = document.getElementById('airportType').value;
      const autoUpdate = document.getElementById('airportAutoUpdate').checked;

      if (!name) { toast('è¯·è¾“å…¥è®¢é˜…åç§°', 'error'); return; }
      if (!url && type === 'http') { toast('è¯·è¾“å…¥è®¢é˜…é“¾æ¥', 'error'); return; }
      if (AppState.proxyProviders[name]) { toast('è¯¥åç§°å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ª', 'error'); return; }

      const provider = { type };
      if (type === 'http') {
        provider.url = url;
        if (autoUpdate) {
          const interval = parseInt(document.getElementById('airportInterval').value) || 86400;
          provider.interval = interval;
        }
      } else {
        provider.path = url;
      }
      if (autoUpdate) {
        const healthUrl = document.getElementById('airportHealthUrl').value.trim();
        const healthInterval = parseInt(document.getElementById('airportHealthInterval').value) || 300;
        provider['health-check'] = { enable: true, url: healthUrl || 'http://www.gstatic.com/generate_204', interval: healthInterval };
      }

      AppState.proxyProviders[name] = provider;

      // Add use reference to selected groups
      document.querySelectorAll('.airport-group-cb:checked').forEach(cb => {
        const gi = parseInt(cb.dataset.group);
        const g = AppState.proxyGroups[gi];
        if (!g) return;
        if (!g.use) g.use = [];
        if (!g.use.includes(name)) g.use.push(name);
      });

      // Clear form
      document.getElementById('airportUrl').value = '';
      document.getElementById('airportName').value = '';
      document.getElementById('airportInterval').value = '86400';
      document.getElementById('airportHealthInterval').value = '300';

      toast('è®¢é˜…æºå·²æ·»åŠ ');
      renderAll();
    }

    function toggleProviderUse(providerName, gi, checked) {
      const g = AppState.proxyGroups[gi];
      if (!g) return;
      if (!g.use) g.use = [];
      if (checked && !g.use.includes(providerName)) {
        g.use.push(providerName);
      } else if (!checked) {
        g.use = g.use.filter(n => n !== providerName);
        if (!g.use.length) delete g.use;
      }
      renderProxyGroups();
    }

    function editProvider(name) {
      const p = AppState.proxyProviders[name];
      if (!p) return;
      const c = document.getElementById('modalContainer');
      const hc = p['health-check'] || {};
      c.innerHTML = `<div class="modal-overlay" onclick="if(event.target===this)closeModal()">
    <div class="modal" style="max-width:520px">
      <h3>ç¼–è¾‘è®¢é˜…æº: ${escHtml(name)}</h3>
      <div class="form-group"><label>åç§°</label><input id="ep_name" value="${escAttr(name)}"></div>
      <div class="form-group"><label>ç±»å‹</label><select id="ep_type">
        <option value="http" ${p.type === 'http' ? 'selected' : ''}>http</option>
        <option value="file" ${p.type === 'file' ? 'selected' : ''}>file</option>
      </select></div>
      <div class="form-group"><label>${p.type === 'http' ? 'è®¢é˜…é“¾æ¥' : 'æ–‡ä»¶è·¯å¾„'}</label><input id="ep_url" class="provider-url-input" value="${escAttr(p.url || p.path || '')}"></div>
      <div class="form-group"><label>æ›´æ–°é—´éš” (ç§’)</label><input id="ep_interval" type="number" value="${p.interval || 86400}"></div>
      <div class="form-group"><label>å¥åº·æ£€æŸ¥ URL</label><input id="ep_hc_url" value="${escAttr(hc.url || 'http://www.gstatic.com/generate_204')}"></div>
      <div class="form-group"><label>æ£€æŸ¥é—´éš” (ç§’)</label><input id="ep_hc_interval" type="number" value="${hc.interval || 300}"></div>
      <div class="btn-group" style="margin-top:16px">
        <button class="btn btn-outline" onclick="closeModal()">å–æ¶ˆ</button>
        <button class="btn btn-primary" onclick="saveProvider('${escAttr(name)}')">ä¿å­˜</button>
      </div>
    </div>
  </div>`;
    }

    function saveProvider(oldName) {
      const newName = document.getElementById('ep_name').value.trim();
      const type = document.getElementById('ep_type').value;
      const url = document.getElementById('ep_url').value.trim();
      const interval = parseInt(document.getElementById('ep_interval').value) || 86400;
      const hcUrl = document.getElementById('ep_hc_url').value.trim();
      const hcInterval = parseInt(document.getElementById('ep_hc_interval').value) || 300;

      if (!newName) { toast('è¯·è¾“å…¥åç§°', 'error'); return; }
      if (newName !== oldName && AppState.proxyProviders[newName]) { toast('è¯¥åç§°å·²å­˜åœ¨', 'error'); return; }

      const provider = { type };
      if (type === 'http') { provider.url = url; provider.interval = interval; }
      else { provider.path = url; }
      provider['health-check'] = { enable: true, url: hcUrl || 'http://www.gstatic.com/generate_204', interval: hcInterval };

      // If renamed, update references
      if (newName !== oldName) {
        delete AppState.proxyProviders[oldName];
        AppState.proxyGroups.forEach(g => {
          if (g.use) {
            const idx = g.use.indexOf(oldName);
            if (idx !== -1) g.use[idx] = newName;
          }
        });
      }
      AppState.proxyProviders[newName] = provider;

      closeModal();
      toast('è®¢é˜…æºå·²æ›´æ–°');
      renderAll();
    }

    function deleteProvider(name) {
      showModal('åˆ é™¤è®¢é˜…æº', `ç¡®å®šè¦åˆ é™¤è®¢é˜…æº "${escHtml(name)}" å—ï¼Ÿå°†ä»æ‰€æœ‰ä»£ç†ç»„çš„ use å¼•ç”¨ä¸­ç§»é™¤ã€‚`, () => {
        delete AppState.proxyProviders[name];
        AppState.proxyGroups.forEach(g => {
          if (g.use) {
            g.use = g.use.filter(n => n !== name);
            if (!g.use.length) delete g.use;
          }
        });
        toast('è®¢é˜…æºå·²åˆ é™¤');
        renderAll();
      });
    }

    // ========== Export (continued) ==========
    function exportConfig() {
      const yamlStr = buildYaml();
      const blob = new Blob([yamlStr], { type: 'text/yaml;charset=utf-8' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = 'clash-config.yaml';
      a.click();
      URL.revokeObjectURL(a.href);
      toast('é…ç½®å·²å¯¼å‡º');
    }

    function togglePreview() {
      const wrap = document.getElementById('yamlPreviewWrap');
      wrap.classList.toggle('show');
      if (wrap.classList.contains('show')) {
        document.getElementById('yamlPreview').textContent = buildYaml();
      }
    }

    function copyYaml() {
      const text = document.getElementById('yamlPreview').textContent;
      navigator.clipboard.writeText(text).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.textContent = 'å·²å¤åˆ¶';
        btn.classList.add('copied');
        setTimeout(() => { btn.textContent = 'å¤åˆ¶'; btn.classList.remove('copied'); }, 1500);
      });
    }

    function buildYaml() {
      const out = {};
      // Preserve all original keys except managed ones
      if (AppState.rawConfig) {
        Object.keys(AppState.rawConfig).forEach(k => {
          if (k !== 'proxies' && k !== 'proxy-groups' && k !== 'proxy-providers') {
            out[k] = AppState.rawConfig[k];
          }
        });
      }
      if (AppState.proxies.length) out.proxies = AppState.proxies;
      if (AppState.proxyGroups.length) out['proxy-groups'] = AppState.proxyGroups;
      if (Object.keys(AppState.proxyProviders).length) {
        out['proxy-providers'] = AppState.proxyProviders;
      }
      return jsyaml.dump(out, { lineWidth: -1, noRefs: true, sortKeys: false, quotingType: '"', forceQuotes: false });
    }

    // ========== Helpers ==========
    function el(id) { return document.getElementById(id); }
    function val(id) { const e = el(id); return e ? e.value.trim() : ''; }
    function intVal(id) { return parseInt(val(id)) || 0; }
    function escHtml(s) { if (!s) return ''; const d = document.createElement('div'); d.textContent = s; return d.innerHTML; }
    function escAttr(s) { if (!s) return ''; return String(s).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;').replace(/</g, '&lt;').replace(/>/g, '&gt;'); }

    // ========== Click outside to collapse proxy groups ==========
    document.addEventListener('click', function (e) {
      const groupsList = document.getElementById('proxyGroupsList');
      if (!groupsList || groupsList.contains(e.target)) return;
      // Clicked outside proxy groups area, collapse all open groups
      groupsList.querySelectorAll('.group-body.show').forEach(body => body.classList.remove('show'));
      groupsList.querySelectorAll('.arrow.open').forEach(arrow => arrow.classList.remove('open'));
    });
  </script>
</body>

</html>